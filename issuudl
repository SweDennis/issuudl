#!/usr/bin/gawk -f

BEGIN {
	while(("wget --quiet -O- "ARGV[1]) | getline) {
		if(index($0, "pageCount")) {
			a = split($0, b, ",")
			for(c = 1; c <= a; c++) {
				split(b[c], d, "[;|:|&]")
				if(d[3] == "title" && ++titleCnt > 1) break
				e[d[3]] = d[8-((d[3] == "pageCount") ? 2 : 0)]
			}
			break
		}
	}

	"mktemp -d" | getline f
	system(("for g in $(seq "1" "e["pageCount"]"); do wget --quiet -P "f" https://image.isu.pub/"e["revisionId"]"-"e["publicationId"]"/jpg/page_${g}.jpg; done"))
	system(("convert $(for g in $(seq "1" "e["pageCount"]"); do echo "f"/page_${g}.jpg; done) \""e["title"]".pdf\""))
	system(("rm -rf "f))
}
